define((function(){"use strict";function t(){}const e=t=>t;function n(t){return t()}function r(){return Object.create(null)}function o(t){t.forEach(n)}function i(t){return"function"==typeof t}function c(t,e){return t!=t?e==e:t!==e||t&&"object"==typeof t||"function"==typeof t}function s(t){return null==t?"":t}const l="undefined"!=typeof window;let a=l?()=>window.performance.now():()=>Date.now(),u=l?t=>requestAnimationFrame(t):t;const f=new Set;function d(t){f.forEach((e=>{e.c(t)||(f.delete(e),e.f())})),0!==f.size&&u(d)}function m(t,e){t.appendChild(e)}function h(t,e,n){const r=p(t);if(!r.getElementById(e)){const t=$("style");t.id=e,t.textContent=n,b(r,t)}}function p(t){if(!t)return document;const e=t.getRootNode?t.getRootNode():t.ownerDocument;return e&&e.host?e:t.ownerDocument}function g(t){const e=$("style");return b(p(t),e),e.sheet}function b(t,e){m(t.head||t,e)}function v(t,e,n){t.insertBefore(e,n||null)}function w(t){t.parentNode.removeChild(t)}function y(t,e){for(let n=0;n<t.length;n+=1)t[n]&&t[n].d(e)}function $(t){return document.createElement(t)}function _(t){return document.createTextNode(t)}function x(){return _(" ")}function C(t,e,n){null==n?t.removeAttribute(e):t.getAttribute(e)!==n&&t.setAttribute(e,n)}function E(t,e){e=""+e,t.wholeText!==e&&(t.data=e)}const k=new Map;let j,q=0;function M(t,e,n,r,o,i,c,s=0){const l=16.666/r;let a="{\n";for(let t=0;t<=1;t+=l){const r=e+(n-e)*i(t);a+=100*t+`%{${c(r,1-r)}}\n`}const u=a+`100% {${c(n,1-n)}}\n}`,f=`__svelte_${function(t){let e=5381,n=t.length;for(;n--;)e=(e<<5)-e^t.charCodeAt(n);return e>>>0}(u)}_${s}`,d=p(t),{stylesheet:m,rules:h}=k.get(d)||function(t,e){const n={stylesheet:g(e),rules:{}};return k.set(t,n),n}(d,t);h[f]||(h[f]=!0,m.insertRule(`@keyframes ${f} ${u}`,m.cssRules.length));const b=t.style.animation||"";return t.style.animation=`${b?`${b}, `:""}${f} ${r}ms linear ${o}ms 1 both`,q+=1,f}function O(t,e){const n=(t.style.animation||"").split(", "),r=n.filter(e?t=>t.indexOf(e)<0:t=>-1===t.indexOf("__svelte")),o=n.length-r.length;o&&(t.style.animation=r.join(", "),q-=o,q||u((()=>{q||(k.forEach((t=>{const{stylesheet:e}=t;let n=e.cssRules.length;for(;n--;)e.deleteRule(n);t.rules={}})),k.clear())})))}function A(t){j=t}const T=[],R=[],L=[],N=[],S=Promise.resolve();let P=!1;function F(t){L.push(t)}const z=new Set;let D,G=0;function H(){const t=j;do{for(;G<T.length;){const t=T[G];G++,A(t),B(t.$$)}for(A(null),T.length=0,G=0;R.length;)R.pop()();for(let t=0;t<L.length;t+=1){const e=L[t];z.has(e)||(z.add(e),e())}L.length=0}while(T.length);for(;N.length;)N.pop()();P=!1,z.clear(),A(t)}function B(t){if(null!==t.fragment){t.update(),o(t.before_update);const e=t.dirty;t.dirty=[-1],t.fragment&&t.fragment.p(t.ctx,e),t.after_update.forEach(F)}}function I(t,e,n){t.dispatchEvent(function(t,e,n=!1){const r=document.createEvent("CustomEvent");return r.initCustomEvent(t,n,!1,e),r}(`${e?"intro":"outro"}${n}`))}const X=new Set;let Y;function J(){Y={r:0,c:[],p:Y}}function K(){Y.r||o(Y.c),Y=Y.p}function Q(t,e){t&&t.i&&(X.delete(t),t.i(e))}function U(t,e,n,r){if(t&&t.o){if(X.has(t))return;X.add(t),Y.c.push((()=>{X.delete(t),r&&(n&&t.d(1),r())})),t.o(e)}}const V={duration:0};function W(n,r,c,s){let l=r(n,c),m=s?0:1,h=null,p=null,g=null;function b(){g&&O(n,g)}function v(t,e){const n=t.b-m;return e*=Math.abs(n),{a:m,b:t.b,d:n,duration:e,start:t.start,end:t.start+e,group:t.group}}function w(r){const{delay:i=0,duration:c=300,easing:s=e,tick:w=t,css:y}=l||V,$={start:a()+i,b:r};r||($.group=Y,Y.r+=1),h||p?p=$:(y&&(b(),g=M(n,m,r,c,i,s,y)),r&&w(0,1),h=v($,c),F((()=>I(n,r,"start"))),function(t){let e;0===f.size&&u(d),new Promise((n=>{f.add(e={c:t,f:n})}))}((t=>{if(p&&t>p.start&&(h=v(p,c),p=null,I(n,h.b,"start"),y&&(b(),g=M(n,m,h.b,h.duration,0,s,l.css))),h)if(t>=h.end)w(m=h.b,1-m),I(n,h.b,"end"),p||(h.b?b():--h.group.r||o(h.group.c)),h=null;else if(t>=h.start){const e=t-h.start;m=h.a+h.d*s(e/h.duration),w(m,1-m)}return!(!h&&!p)})))}return{run(t){i(l)?(D||(D=Promise.resolve(),D.then((()=>{D=null}))),D).then((()=>{l=l(),w(t)})):w(t)},end(){b(),h=p=null}}}function Z(t,e,r,c){const{fragment:s,on_mount:l,on_destroy:a,after_update:u}=t.$$;s&&s.m(e,r),c||F((()=>{const e=l.map(n).filter(i);a?a.push(...e):o(e),t.$$.on_mount=[]})),u.forEach(F)}function tt(t,e){const n=t.$$;null!==n.fragment&&(o(n.on_destroy),n.fragment&&n.fragment.d(e),n.on_destroy=n.fragment=null,n.ctx=[])}function et(t,e){-1===t.$$.dirty[0]&&(T.push(t),P||(P=!0,S.then(H)),t.$$.dirty.fill(0)),t.$$.dirty[e/31|0]|=1<<e%31}function nt(e,n,i,c,s,l,a,u=[-1]){const f=j;A(e);const d=e.$$={fragment:null,ctx:null,props:l,update:t,not_equal:s,bound:r(),on_mount:[],on_destroy:[],on_disconnect:[],before_update:[],after_update:[],context:new Map(n.context||(f?f.$$.context:[])),callbacks:r(),dirty:u,skip_bound:!1,root:n.target||f.$$.root};a&&a(d.root);let m=!1;if(d.ctx=i?i(e,n.props||{},((t,n,...r)=>{const o=r.length?r[0]:n;return d.ctx&&s(d.ctx[t],d.ctx[t]=o)&&(!d.skip_bound&&d.bound[t]&&d.bound[t](o),m&&et(e,t)),n})):[],d.update(),m=!0,o(d.before_update),d.fragment=!!c&&c(d.ctx),n.target){if(n.hydrate){const t=function(t){return Array.from(t.childNodes)}(n.target);d.fragment&&d.fragment.l(t),t.forEach(w)}else d.fragment&&d.fragment.c();n.intro&&Q(e.$$.fragment),Z(e,n.target,n.anchor,n.customElement),H()}A(f)}class rt{$destroy(){tt(this,1),this.$destroy=t}$on(t,e){const n=this.$$.callbacks[t]||(this.$$.callbacks[t]=[]);return n.push(e),()=>{const t=n.indexOf(e);-1!==t&&n.splice(t,1)}}$set(t){var e;this.$$set&&(e=t,0!==Object.keys(e).length)&&(this.$$.skip_bound=!0,this.$$set(t),this.$$.skip_bound=!1)}}function ot(t,{delay:n=0,duration:r=400,easing:o=e}={}){const i=+getComputedStyle(t).opacity;return{delay:n,duration:r,easing:o,css:t=>"opacity: "+t*i}}function it(t){h(t,"svelte-1q8pnf7",".wrap.svelte-1q8pnf7{margin:10px auto;height:100%;display:flex;justify-content:center;align-items:center}.sp.svelte-1q8pnf7{width:16px;height:16px;top:50%;left:50%;margin-top:-8px;margin-left:-8px;display:block;z-index:101;border:solid 2px transparent;border-top-color:#158fd2;border-left-color:#158fd2;border-radius:100%;-webkit-animation:svelte-1q8pnf7-load 900ms linear infinite;animation:svelte-1q8pnf7-load 900ms linear infinite}@keyframes svelte-1q8pnf7-load{0%{-webkit-transform:rotate(0deg);transform:rotate(0deg)}to{-webkit-transform:rotate(360deg);transform:rotate(360deg)}}")}function ct(e){let n;return{c(){n=$("div"),n.innerHTML='<div class="sp svelte-1q8pnf7"></div>',C(n,"class","wrap svelte-1q8pnf7")},m(t,e){v(t,n,e)},p:t,i:t,o:t,d(t){t&&w(n)}}}class st extends rt{constructor(t){super(),nt(this,t,null,ct,c,{},it)}}function lt(t="",e="POST"){return fetch(t,{headers:{"x-requested-with":"XMLHttpRequest"},method:e})}function at(t=""){return Object.values(AMOCRM.constant("account").cf).filter((e=>1===e[`ENTREE_${t}`])).length}function ut(t=!0){return Object.values(AMOCRM.constant("managers")).filter((e=>e.active===t)).length}async function ft(t){return new Promise((e=>{setTimeout((()=>{e(!0)}),t)}))}async function dt(){const t=await async function(){const t=await lt("/private/api/v2/json/accounts/current","GET");try{const e=await t.json();return 200===t.status?e.response.account.limits:0}catch(t){return 0}}();await ft(300);const e=await async function(){const t=await lt("/ajax/settings/custom_fields/");try{const e=await t.json();return 200===t.status?e.response.params.tariff.cf_max_count:0}catch(t){return 0}}();await ft(300);const n=await async function(){const t=await lt("/ajax/leads/list/");try{const e=await t.json();return 200===t.status?e.response.summary.count:0}catch(t){return 0}}();await ft(300);const r=await async function(){const t=await lt("/api/v4/contacts","GET");try{const e=await t.json();return 200===t.status?e._embedded.contacts.length:0}catch(t){return 0}}();await ft(300);const o=await async function(){const t=await lt("/api/v4/companies","GET");try{const e=await t.json();return 200===t.status?e._embedded.companies.length:0}catch(t){return 0}}();return await ft(300),{accountLimits:t,countCustomFields:e,leadsCount:n,contactsCount:r,companyCount:o}}function mt(t){h(t,"svelte-1hr73eu",".main_block.svelte-1hr73eu.svelte-1hr73eu{position:absolute;left:calc(50% - 150px)}.over_limit.svelte-1hr73eu.svelte-1hr73eu{font-weight:bold;color:red}.allowed_limit.svelte-1hr73eu.svelte-1hr73eu{font-weight:bold;color:green}.account_info_button.svelte-1hr73eu.svelte-1hr73eu{border:1px solid #dbdedf;border-radius:3px;padding:5px 80px;background-color:#4c8bf7;cursor:pointer;text-align:center}.title.svelte-1hr73eu.svelte-1hr73eu{color:white;font-size:17px;font-weight:bold;margin-bottom:10px}.account_info.svelte-1hr73eu .title.svelte-1hr73eu{color:black;text-align:center}.account_info.svelte-1hr73eu.svelte-1hr73eu{border:1px solid #dbdedf;border-radius:0 0 3px 3px;position:relative;background-color:white;padding:10px}.account_info.svelte-1hr73eu .item.svelte-1hr73eu{display:flex;align-items:center;justify-content:space-between;margin-bottom:2px}")}function ht(t,e,n){const r=t.slice();return r[4]=e[n],r}function pt(t,e,n){const r=t.slice();return r[7]=e[n],r}function gt(t){let e,n,r,o,i=t[2]&&bt(),c=t[0],s=[];for(let e=0;e<c.length;e+=1)s[e]=$t(ht(t,c,e));return{c(){e=$("div"),i&&i.c(),n=x();for(let t=0;t<s.length;t+=1)s[t].c();C(e,"class","account_info svelte-1hr73eu")},m(t,r){v(t,e,r),i&&i.m(e,null),m(e,n);for(let t=0;t<s.length;t+=1)s[t].m(e,null);o=!0},p(t,r){if(t[2]?i?4&r&&Q(i,1):(i=bt(),i.c(),Q(i,1),i.m(e,n)):i&&(J(),U(i,1,1,(()=>{i=null})),K()),1&r){let n;for(c=t[0],n=0;n<c.length;n+=1){const o=ht(t,c,n);s[n]?s[n].p(o,r):(s[n]=$t(o),s[n].c(),s[n].m(e,null))}for(;n<s.length;n+=1)s[n].d(1);s.length=c.length}},i(t){o||(Q(i),F((()=>{r||(r=W(e,ot,{duration:300},!0)),r.run(1)})),o=!0)},o(t){U(i),r||(r=W(e,ot,{duration:300},!1)),r.run(0),o=!1},d(t){t&&w(e),i&&i.d(),y(s,t),t&&r&&r.end()}}}function bt(t){let e,n,r;return n=new st({}),{c(){var t;e=_("Получаем данные о лимитах аккаунта...\n        "),(t=n.$$.fragment)&&t.c()},m(t,o){v(t,e,o),Z(n,t,o),r=!0},i(t){r||(Q(n.$$.fragment,t),r=!0)},o(t){U(n.$$.fragment,t),r=!1},d(t){t&&w(e),tt(n,t)}}}function vt(t){let e,n,r=t[7].current+"";return{c(){e=$("span"),n=_(r)},m(t,r){v(t,e,r),m(e,n)},p(t,e){1&e&&r!==(r=t[7].current+"")&&E(n,r)},d(t){t&&w(e)}}}function wt(t){let e,n,r,o,i,c,l=t[7].current+"",a=t[7].limit+"";return{c(){e=$("span"),n=_(l),o=$("span"),o.textContent="/",i=$("span"),c=_(a),C(e,"class",r=s(t[7].current>=t[7].limit?"over_limit":"allowed_limit")+" svelte-1hr73eu")},m(t,r){v(t,e,r),m(e,n),v(t,o,r),v(t,i,r),m(i,c)},p(t,o){1&o&&l!==(l=t[7].current+"")&&E(n,l),1&o&&r!==(r=s(t[7].current>=t[7].limit?"over_limit":"allowed_limit")+" svelte-1hr73eu")&&C(e,"class",r),1&o&&a!==(a=t[7].limit+"")&&E(c,a)},d(t){t&&w(e),t&&w(o),t&&w(i)}}}function yt(t){let e,n,r,o,i,c,s=t[7].label+"";function l(t,e){return t[7].limit?wt:vt}let a=l(t),u=a(t);return{c(){e=$("div"),n=$("div"),r=_(s),o=x(),i=$("div"),u.c(),c=x(),C(n,"class","label-limit"),C(i,"class","count-limit"),C(e,"class","item svelte-1hr73eu")},m(t,s){v(t,e,s),m(e,n),m(n,r),m(e,o),m(e,i),u.m(i,null),m(e,c)},p(t,e){1&e&&s!==(s=t[7].label+"")&&E(r,s),a===(a=l(t))&&u?u.p(t,e):(u.d(1),u=a(t),u&&(u.c(),u.m(i,null)))},d(t){t&&w(e),u.d()}}}function $t(t){let e,n,r,o,i=t[4].headers+"",c=t[4].fields,s=[];for(let e=0;e<c.length;e+=1)s[e]=yt(pt(t,c,e));return{c(){e=$("h3"),n=_(i),r=x();for(let t=0;t<s.length;t+=1)s[t].c();o=_(""),C(e,"class","title svelte-1hr73eu")},m(t,i){v(t,e,i),m(e,n),v(t,r,i);for(let e=0;e<s.length;e+=1)s[e].m(t,i);v(t,o,i)},p(t,e){if(1&e&&i!==(i=t[4].headers+"")&&E(n,i),1&e){let n;for(c=t[4].fields,n=0;n<c.length;n+=1){const r=pt(t,c,n);s[n]?s[n].p(r,e):(s[n]=yt(r),s[n].c(),s[n].m(o.parentNode,o))}for(;n<s.length;n+=1)s[n].d(1);s.length=c.length}},d(t){t&&w(e),t&&w(r),y(s,t),t&&w(o)}}}function _t(t){let e,n,r,o,i,c,s=!t[1]&&gt(t);return{c(){e=$("div"),n=$("div"),n.innerHTML='<span class="title svelte-1hr73eu">Лимиты аккаунта</span>',r=x(),s&&s.c(),C(n,"class","account_info_button svelte-1hr73eu"),C(e,"class","main_block svelte-1hr73eu")},m(l,a){var u,f,d,h;v(l,e,a),m(e,n),m(e,r),s&&s.m(e,null),o=!0,i||(u=n,f="click",d=t[3],u.addEventListener(f,d,h),c=()=>u.removeEventListener(f,d,h),i=!0)},p(t,[n]){t[1]?s&&(J(),U(s,1,1,(()=>{s=null})),K()):s?(s.p(t,n),2&n&&Q(s,1)):(s=gt(t),s.c(),Q(s,1),s.m(e,null))},i(t){o||(Q(s),o=!0)},o(t){U(s),o=!1},d(t){t&&w(e),s&&s.d(),i=!1,c()}}}function xt(t,e,n){let r=[],o=!0,i=!1;return[r,o,i,async function(){n(1,o=!o),0===r.length&&(n(2,i=!0),n(0,r=await async function(){try{const t=await dt();return[{headers:"Сущности",fields:[{current:t.leadsCount,limit:t.accountLimits.active_deals_count,label:"Сделки"},{current:t.contactsCount,limit:50,label:"Контакты"},{current:t.companyCount,limit:50,label:"Компании"},{current:ut(),limit:t.accountLimits.users_count,label:"Пользователи (активные)"},{current:ut(!1),label:"Пользователи (не активные)"}]},{headers:"Поля",fields:[{current:at("DEALS"),limit:t.countCustomFields,label:"Сделка"},{current:at("CONTACTS"),limit:t.countCustomFields,label:"Контакт"},{current:at("COMPANY"),limit:t.countCustomFields,label:"Компания"}]}]}catch(t){return[{headers:"Сущности",fields:[{current:0,limit:0,label:"Сделки"},{current:0,limit:0,label:"Контакты"},{current:0,limit:0,label:"Компании"},{current:0,limit:0,label:"Пользователи (активные)"},{current:0,label:"Пользователи (не активные)"}]},{headers:"Поля",fields:[{current:0,limit:0,label:"Сделка"},{current:0,limit:0,label:"Контакт"},{current:0,limit:0,label:"Компания"}]}]}}()),n(2,i=!1))}]}class Ct extends rt{constructor(t){super(),nt(this,t,xt,_t,c,{},mt)}}return function(){return(t=>{if(window[t])throw new Error("Двойная инициализация виджета.");window[t]=!0})("__limit_account_v2__"),this.callbacks={render:async()=>("settings"!==AMOCRM.widgets.system.area||new Ct({target:document.querySelector(".public-integrations-list"),props:{}}),!0),bind_actions:()=>!0,onSave:()=>!0,init:()=>!0,settings:()=>!0},this}}));
