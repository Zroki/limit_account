define((function(){"use strict";function t(){}const e=t=>t;function n(t){return t()}function o(){return Object.create(null)}function r(t){t.forEach(n)}function i(t){return"function"==typeof t}function c(t,e){return t!=t?e==e:t!==e||t&&"object"==typeof t||"function"==typeof t}function s(t){return null==t?"":t}const l="undefined"!=typeof window;let a=l?()=>window.performance.now():()=>Date.now(),u=l?t=>requestAnimationFrame(t):t;const f=new Set;function d(t){f.forEach((e=>{e.c(t)||(f.delete(e),e.f())})),0!==f.size&&u(d)}function m(t,e){t.appendChild(e)}function p(t,e,n){const o=h(t);if(!o.getElementById(e)){const t=$("style");t.id=e,t.textContent=n,w(o,t)}}function h(t){if(!t)return document;const e=t.getRootNode?t.getRootNode():t.ownerDocument;return e&&e.host?e:t.ownerDocument}function g(t){const e=$("style");return w(h(t),e),e.sheet}function w(t,e){m(t.head||t,e)}function b(t,e,n){t.insertBefore(e,n||null)}function v(t){t.parentNode.removeChild(t)}function y(t,e){for(let n=0;n<t.length;n+=1)t[n]&&t[n].d(e)}function $(t){return document.createElement(t)}function _(t){return document.createTextNode(t)}function k(){return _(" ")}function x(t,e,n){null==n?t.removeAttribute(e):t.getAttribute(e)!==n&&t.setAttribute(e,n)}function z(t,e){e=""+e,t.wholeText!==e&&(t.data=e)}const C=new Map;let E,j=0;function q(t,e,n,o,r,i,c,s=0){const l=16.666/o;let a="{\n";for(let t=0;t<=1;t+=l){const o=e+(n-e)*i(t);a+=100*t+`%{${c(o,1-o)}}\n`}const u=a+`100% {${c(n,1-n)}}\n}`,f=`__svelte_${function(t){let e=5381,n=t.length;for(;n--;)e=(e<<5)-e^t.charCodeAt(n);return e>>>0}(u)}_${s}`,d=h(t),{stylesheet:m,rules:p}=C.get(d)||function(t,e){const n={stylesheet:g(e),rules:{}};return C.set(t,n),n}(d,t);p[f]||(p[f]=!0,m.insertRule(`@keyframes ${f} ${u}`,m.cssRules.length));const w=t.style.animation||"";return t.style.animation=`${w?`${w}, `:""}${f} ${o}ms linear ${r}ms 1 both`,j+=1,f}function M(t,e){const n=(t.style.animation||"").split(", "),o=n.filter(e?t=>t.indexOf(e)<0:t=>-1===t.indexOf("__svelte")),r=n.length-o.length;r&&(t.style.animation=o.join(", "),j-=r,j||u((()=>{j||(C.forEach((t=>{const{stylesheet:e}=t;let n=e.cssRules.length;for(;n--;)e.deleteRule(n);t.rules={}})),C.clear())})))}function O(t){E=t}const A=[],T=[],R=[],L=[],N=Promise.resolve();let S=!1;function P(t){R.push(t)}const F=new Set;let D,G=0;function H(){const t=E;do{for(;G<A.length;){const t=A[G];G++,O(t),B(t.$$)}for(O(null),A.length=0,G=0;T.length;)T.pop()();for(let t=0;t<R.length;t+=1){const e=R[t];F.has(e)||(F.add(e),e())}R.length=0}while(A.length);for(;L.length;)L.pop()();S=!1,F.clear(),O(t)}function B(t){if(null!==t.fragment){t.update(),r(t.before_update);const e=t.dirty;t.dirty=[-1],t.fragment&&t.fragment.p(t.ctx,e),t.after_update.forEach(P)}}function I(t,e,n){t.dispatchEvent(function(t,e,n=!1){const o=document.createEvent("CustomEvent");return o.initCustomEvent(t,n,!1,e),o}(`${e?"intro":"outro"}${n}`))}const X=new Set;let Y;function J(){Y={r:0,c:[],p:Y}}function K(){Y.r||r(Y.c),Y=Y.p}function Q(t,e){t&&t.i&&(X.delete(t),t.i(e))}function U(t,e,n,o){if(t&&t.o){if(X.has(t))return;X.add(t),Y.c.push((()=>{X.delete(t),o&&(n&&t.d(1),o())})),t.o(e)}}const V={duration:0};function W(n,o,c,s){let l=o(n,c),m=s?0:1,p=null,h=null,g=null;function w(){g&&M(n,g)}function b(t,e){const n=t.b-m;return e*=Math.abs(n),{a:m,b:t.b,d:n,duration:e,start:t.start,end:t.start+e,group:t.group}}function v(o){const{delay:i=0,duration:c=300,easing:s=e,tick:v=t,css:y}=l||V,$={start:a()+i,b:o};o||($.group=Y,Y.r+=1),p||h?h=$:(y&&(w(),g=q(n,m,o,c,i,s,y)),o&&v(0,1),p=b($,c),P((()=>I(n,o,"start"))),function(t){let e;0===f.size&&u(d),new Promise((n=>{f.add(e={c:t,f:n})}))}((t=>{if(h&&t>h.start&&(p=b(h,c),h=null,I(n,p.b,"start"),y&&(w(),g=q(n,m,p.b,p.duration,0,s,l.css))),p)if(t>=p.end)v(m=p.b,1-m),I(n,p.b,"end"),h||(p.b?w():--p.group.r||r(p.group.c)),p=null;else if(t>=p.start){const e=t-p.start;m=p.a+p.d*s(e/p.duration),v(m,1-m)}return!(!p&&!h)})))}return{run(t){i(l)?(D||(D=Promise.resolve(),D.then((()=>{D=null}))),D).then((()=>{l=l(),v(t)})):v(t)},end(){w(),p=h=null}}}function Z(t,e,o,c){const{fragment:s,on_mount:l,on_destroy:a,after_update:u}=t.$$;s&&s.m(e,o),c||P((()=>{const e=l.map(n).filter(i);a?a.push(...e):r(e),t.$$.on_mount=[]})),u.forEach(P)}function tt(t,e){const n=t.$$;null!==n.fragment&&(r(n.on_destroy),n.fragment&&n.fragment.d(e),n.on_destroy=n.fragment=null,n.ctx=[])}function et(t,e){-1===t.$$.dirty[0]&&(A.push(t),S||(S=!0,N.then(H)),t.$$.dirty.fill(0)),t.$$.dirty[e/31|0]|=1<<e%31}function nt(e,n,i,c,s,l,a,u=[-1]){const f=E;O(e);const d=e.$$={fragment:null,ctx:null,props:l,update:t,not_equal:s,bound:o(),on_mount:[],on_destroy:[],on_disconnect:[],before_update:[],after_update:[],context:new Map(n.context||(f?f.$$.context:[])),callbacks:o(),dirty:u,skip_bound:!1,root:n.target||f.$$.root};a&&a(d.root);let m=!1;if(d.ctx=i?i(e,n.props||{},((t,n,...o)=>{const r=o.length?o[0]:n;return d.ctx&&s(d.ctx[t],d.ctx[t]=r)&&(!d.skip_bound&&d.bound[t]&&d.bound[t](r),m&&et(e,t)),n})):[],d.update(),m=!0,r(d.before_update),d.fragment=!!c&&c(d.ctx),n.target){if(n.hydrate){const t=function(t){return Array.from(t.childNodes)}(n.target);d.fragment&&d.fragment.l(t),t.forEach(v)}else d.fragment&&d.fragment.c();n.intro&&Q(e.$$.fragment),Z(e,n.target,n.anchor,n.customElement),H()}O(f)}class ot{$destroy(){tt(this,1),this.$destroy=t}$on(t,e){const n=this.$$.callbacks[t]||(this.$$.callbacks[t]=[]);return n.push(e),()=>{const t=n.indexOf(e);-1!==t&&n.splice(t,1)}}$set(t){var e;this.$$set&&(e=t,0!==Object.keys(e).length)&&(this.$$.skip_bound=!0,this.$$set(t),this.$$.skip_bound=!1)}}function rt(t,{delay:n=0,duration:o=400,easing:r=e}={}){const i=+getComputedStyle(t).opacity;return{delay:n,duration:o,easing:r,css:t=>"opacity: "+t*i}}function it(t){p(t,"svelte-1q8pnf7",".wrap.svelte-1q8pnf7{margin:10px auto;height:100%;display:flex;justify-content:center;align-items:center}.sp.svelte-1q8pnf7{width:16px;height:16px;top:50%;left:50%;margin-top:-8px;margin-left:-8px;display:block;z-index:101;border:solid 2px transparent;border-top-color:#158fd2;border-left-color:#158fd2;border-radius:100%;-webkit-animation:svelte-1q8pnf7-load 900ms linear infinite;animation:svelte-1q8pnf7-load 900ms linear infinite}@keyframes svelte-1q8pnf7-load{0%{-webkit-transform:rotate(0deg);transform:rotate(0deg)}to{-webkit-transform:rotate(360deg);transform:rotate(360deg)}}")}function ct(e){let n;return{c(){n=$("div"),n.innerHTML='<div class="sp svelte-1q8pnf7"></div>',x(n,"class","wrap svelte-1q8pnf7")},m(t,e){b(t,n,e)},p:t,i:t,o:t,d(t){t&&v(n)}}}class st extends ot{constructor(t){super(),nt(this,t,null,ct,c,{},it)}}function lt(t="",e="POST"){return fetch(t,{headers:{"x-requested-with":"XMLHttpRequest"},method:e})}function at(t=""){return Object.values(AMOCRM.constant("account").cf).filter((e=>1===e[`ENTREE_${t}`])).length}function ut(t=!0){return Object.values(AMOCRM.constant("managers")).filter((e=>e.active===t)).length}async function ft(t){return new Promise((e=>{setTimeout((()=>{e(!0)}),t)}))}async function dt(){const t=await async function(){const t=await lt("/private/api/v2/json/accounts/current","GET");try{const e=await t.json();return 200===t.status?e.response.account.limits:0}catch(t){return 0}}();await ft(300);const e=await async function(){const t=await lt("/ajax/settings/custom_fields/");try{const e=await t.json();return 200===t.status?e.response.params.tariff.cf_max_count:0}catch(t){return 0}}();await ft(300);const n=await async function(){const t=await lt("/ajax/leads/list/");try{const e=await t.json();return 200===t.status?e.response.summary.count:0}catch(t){return 0}}();await ft(300);const o=await async function(){const t=await lt("/api/v4/contacts","GET");try{const e=await t.json();return 200===t.status?e._embedded.contacts.length:0}catch(t){return 0}}();await ft(300);const r=await async function(){const t=await lt("/api/v4/companies","GET");try{const e=await t.json();return 200===t.status?e._embedded.companies.length:0}catch(t){return 0}}();return await ft(300),{accountLimits:t,countCustomFields:e,leadsCount:n,contactsCount:o,companyCount:r}}function mt(t){p(t,"svelte-ik9mzw",".main_block.svelte-ik9mzw.svelte-ik9mzw{position:absolute;left:calc(50% - 150px)}.over_limit.svelte-ik9mzw.svelte-ik9mzw{font-weight:bold;color:red}.allowed_limit.svelte-ik9mzw.svelte-ik9mzw{color:green}.account_info_button.svelte-ik9mzw.svelte-ik9mzw{border:1px solid #dbdedf;border-radius:3px;padding:5px 80px;background-color:#4c8bf7;cursor:pointer;text-align:center}.title.svelte-ik9mzw.svelte-ik9mzw{color:white;font-size:17px;font-weight:bold;margin-bottom:10px}.account_info.svelte-ik9mzw .title.svelte-ik9mzw{color:black;text-align:center}.account_info.svelte-ik9mzw.svelte-ik9mzw{border:1px solid #dbdedf;border-radius:0 0 3px 3px;position:relative;background-color:white;padding:10px}.account_info.svelte-ik9mzw .item.svelte-ik9mzw{display:flex;align-items:center;justify-content:space-between;margin-bottom:2px}")}function pt(t,e,n){const o=t.slice();return o[4]=e[n],o}function ht(t,e,n){const o=t.slice();return o[7]=e[n],o}function gt(t){let e,n,o,r,i=t[2]&&wt(),c=t[0],s=[];for(let e=0;e<c.length;e+=1)s[e]=$t(pt(t,c,e));return{c(){e=$("div"),i&&i.c(),n=k();for(let t=0;t<s.length;t+=1)s[t].c();x(e,"class","account_info svelte-ik9mzw")},m(t,o){b(t,e,o),i&&i.m(e,null),m(e,n);for(let t=0;t<s.length;t+=1)s[t].m(e,null);r=!0},p(t,o){if(t[2]?i?4&o&&Q(i,1):(i=wt(),i.c(),Q(i,1),i.m(e,n)):i&&(J(),U(i,1,1,(()=>{i=null})),K()),1&o){let n;for(c=t[0],n=0;n<c.length;n+=1){const r=pt(t,c,n);s[n]?s[n].p(r,o):(s[n]=$t(r),s[n].c(),s[n].m(e,null))}for(;n<s.length;n+=1)s[n].d(1);s.length=c.length}},i(t){r||(Q(i),P((()=>{o||(o=W(e,rt,{duration:300},!0)),o.run(1)})),r=!0)},o(t){U(i),o||(o=W(e,rt,{duration:300},!1)),o.run(0),r=!1},d(t){t&&v(e),i&&i.d(),y(s,t),t&&o&&o.end()}}}function wt(t){let e,n,o;return n=new st({}),{c(){var t;e=_("Получаем данные о лимитах аккаунта...\n        "),(t=n.$$.fragment)&&t.c()},m(t,r){b(t,e,r),Z(n,t,r),o=!0},i(t){o||(Q(n.$$.fragment,t),o=!0)},o(t){U(n.$$.fragment,t),o=!1},d(t){t&&v(e),tt(n,t)}}}function bt(t){let e,n,o=t[7].current+"";return{c(){e=$("span"),n=_(o)},m(t,o){b(t,e,o),m(e,n)},p(t,e){1&e&&o!==(o=t[7].current+"")&&z(n,o)},d(t){t&&v(e)}}}function vt(t){let e,n,o,r,i,c,l,a=t[7].current+"",u=t[7].limit+"";return{c(){e=$("span"),n=_(a),o=_("/"),i=k(),c=$("span"),l=_(u),x(e,"class",r=s(t[7].current>=t[7].limit?"over_limit":"allowed_limit")+" svelte-ik9mzw")},m(t,r){b(t,e,r),m(e,n),m(e,o),b(t,i,r),b(t,c,r),m(c,l)},p(t,o){1&o&&a!==(a=t[7].current+"")&&z(n,a),1&o&&r!==(r=s(t[7].current>=t[7].limit?"over_limit":"allowed_limit")+" svelte-ik9mzw")&&x(e,"class",r),1&o&&u!==(u=t[7].limit+"")&&z(l,u)},d(t){t&&v(e),t&&v(i),t&&v(c)}}}function yt(t){let e,n,o,r,i,c,s=t[7].label+"";function l(t,e){return t[7].limit?vt:bt}let a=l(t),u=a(t);return{c(){e=$("div"),n=$("span"),o=_(s),r=k(),i=$("span"),u.c(),c=k(),x(e,"class","item svelte-ik9mzw")},m(t,s){b(t,e,s),m(e,n),m(n,o),m(e,r),m(e,i),u.m(i,null),m(e,c)},p(t,e){1&e&&s!==(s=t[7].label+"")&&z(o,s),a===(a=l(t))&&u?u.p(t,e):(u.d(1),u=a(t),u&&(u.c(),u.m(i,null)))},d(t){t&&v(e),u.d()}}}function $t(t){let e,n,o,r,i=t[4].headers+"",c=t[4].fields,s=[];for(let e=0;e<c.length;e+=1)s[e]=yt(ht(t,c,e));return{c(){e=$("h3"),n=_(i),o=k();for(let t=0;t<s.length;t+=1)s[t].c();r=_(""),x(e,"class","title svelte-ik9mzw")},m(t,i){b(t,e,i),m(e,n),b(t,o,i);for(let e=0;e<s.length;e+=1)s[e].m(t,i);b(t,r,i)},p(t,e){if(1&e&&i!==(i=t[4].headers+"")&&z(n,i),1&e){let n;for(c=t[4].fields,n=0;n<c.length;n+=1){const o=ht(t,c,n);s[n]?s[n].p(o,e):(s[n]=yt(o),s[n].c(),s[n].m(r.parentNode,r))}for(;n<s.length;n+=1)s[n].d(1);s.length=c.length}},d(t){t&&v(e),t&&v(o),y(s,t),t&&v(r)}}}function _t(t){let e,n,o,r,i,c,s=!t[1]&&gt(t);return{c(){e=$("div"),n=$("div"),n.innerHTML='<span class="title svelte-ik9mzw">Лимиты аккаунта</span>',o=k(),s&&s.c(),x(n,"class","account_info_button svelte-ik9mzw"),x(e,"class","main_block svelte-ik9mzw")},m(l,a){var u,f,d,p;b(l,e,a),m(e,n),m(e,o),s&&s.m(e,null),r=!0,i||(u=n,f="click",d=t[3],u.addEventListener(f,d,p),c=()=>u.removeEventListener(f,d,p),i=!0)},p(t,[n]){t[1]?s&&(J(),U(s,1,1,(()=>{s=null})),K()):s?(s.p(t,n),2&n&&Q(s,1)):(s=gt(t),s.c(),Q(s,1),s.m(e,null))},i(t){r||(Q(s),r=!0)},o(t){U(s),r=!1},d(t){t&&v(e),s&&s.d(),i=!1,c()}}}function kt(t,e,n){let o=[],r=!0,i=!1;return[o,r,i,async function(){n(1,r=!r),0===o.length&&(n(2,i=!0),n(0,o=await async function(){try{const t=await dt();return[{headers:"Сущности",fields:[{current:t.leadsCount,limit:t.accountLimits.active_deals_count,label:"Сделки"},{current:t.contactsCount,limit:50,label:"Контакты"},{current:t.companyCount,limit:50,label:"Компании"},{current:ut(),limit:t.accountLimits.users_count,label:"Пользователи (активные)"},{current:ut(!1),label:"Пользователи (не активные)"}]},{headers:"Поля",fields:[{current:at("DEALS"),limit:t.countCustomFields,label:"Сделка"},{current:at("CONTACTS"),limit:t.countCustomFields,label:"Контакт"},{current:at("COMPANY"),limit:t.countCustomFields,label:"Компания"}]}]}catch(t){return[{headers:"Сущности",fields:[{current:0,limit:0,label:"Сделки"},{current:0,limit:0,label:"Контакты"},{current:0,limit:0,label:"Компании"},{current:0,limit:0,label:"Пользователи (активные)"},{current:0,label:"Пользователи (не активные)"}]},{headers:"Поля",fields:[{current:0,limit:0,label:"Сделка"},{current:0,limit:0,label:"Контакт"},{current:0,limit:0,label:"Компания"}]}]}}()),n(2,i=!1))}]}class xt extends ot{constructor(t){super(),nt(this,t,kt,_t,c,{},mt)}}return function(){return(t=>{if(window[t])throw new Error("Двойная инициализация виджета.");window[t]=!0})("__limit_account_v2__"),this.callbacks={render:async()=>("settings"!==AMOCRM.widgets.system.area||new xt({target:document.querySelector(".public-integrations-list"),props:{}}),!0),bind_actions:()=>!0,onSave:()=>!0,init:()=>!0,settings:()=>!0},this}}));
